<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Estudos - TJCE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Estilos básicos e de layout */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        .container {
            max-width: 1400px; 
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        h1, h2, h4 {
            color: #004d99; /* Azul institucional */
        }
        
        h4 {
            margin-top: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid #cce0ff;
            padding-bottom: 5px;
        }

        /* Área de Sumário */
        .summary-box {
            background-color: #e6f2ff;
            border: 1px solid #cce0ff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .summary-item strong {
            display: block;
            font-size: 1.5em;
            color: #007bff;
        }
        
        /* Controles e Importação */
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background-color: #f9f9f9;
        }
        
        /* NOVO: Estilo para agrupar controles */
        .control-group {
            margin-bottom: 20px;
            padding: 10px 0;
        }
        .input-line {
            margin-top: 10px;
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Garante quebras em telas menores */
        }
        .input-line label {
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }
        
        /* MUDANÇA: Oculta o input nativo de arquivo */
        .hidden-file-input {
            display: none;
        }
        
        .file-note {
            margin-left: 15px;
            font-size: 0.85em;
            color: #cc0000;
        }

        .controls button, .controls input[type="file"], .controls input[type="text"], .controls input[type="number"] {
            padding: 8px 12px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .action-btn { background-color: #007bff; color: white; }
        .action-btn:hover { background-color: #0056b3; }
        .rename-input { width: 150px; border: 1px solid #ccc; padding: 7px; }
        .delete-btn { background-color: #dc3545; color: white; }
        .delete-btn:hover { background-color: #c82333; }
        .add-btn { 
            background-color: #28a745; 
            color: white; 
            margin-top: 10px; 
            padding: 10px 15px;
        }
        .add-btn:hover { background-color: #1e7e34; }


        /* Estilos da Navegação por Abas */
        .tab-nav {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #ccc;
            margin-bottom: 10px;
        }
        .tab-button {
            padding: 10px 15px;
            border: none;
            border-bottom: 3px solid transparent;
            background-color: transparent;
            cursor: pointer;
            font-size: 1em;
            transition: border-bottom-color 0.3s, color 0.3s;
            margin-right: 5px;
            color: #555;
            font-weight: bold;
        }
        .tab-button:hover {
            color: #004d99;
            border-bottom: 3px solid #b3d9ff;
        }
        .tab-button.active {
            border-bottom: 3px solid #007bff; /* Cor ativa */
            color: #007bff;
            background-color: #e6f2ff;
        }

        /* Conteúdo das Abas (Semanas) */
        .semana-section {
            display: none;
            padding: 15px 0;
        }
        .semana-section.active {
            display: block;
        }

        /* Estilo da Tabela de Cronograma */
        .cronograma-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            table-layout: fixed; /* Fixa o layout para respeitar as larguras */
        }
        .cronograma-table th, .cronograma-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            word-wrap: break-word; /* Permite quebras de linha em textos longos */
        }
        .cronograma-table th {
            background-color: #004d99;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
        }
        .cronograma-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        /* Otimização de Largura */
        :root {
            --col-disciplina-width: 18%; 
            --col-conteudo-max-width: 45%;
        }
        
        .col-meta { width: 50px; } 
        .col-disciplina { width: var(--col-disciplina-width); }
        /* AJUSTE PRINCIPAL: Coluna Conteúdo flexível */
        .col-conteudo { width: auto; max-width: var(--col-conteudo-max-width); } 
        .col-link { width: 60px; text-align: center; } 
        .col-concluida { width: 70px; text-align: center; }
        .col-feitas, .col-acertadas { width: 55px; text-align: center; }
        .col-percent { width: 60px; text-align: center; font-size: 0.9em; } 
        .col-acoes { width: 70px; text-align: center; } 
        
        /* Estilo dos Inputs na Tabela */
        .cronograma-table input[type="text"], 
        .cronograma-table textarea { 
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        /* ESTILO FUNDAMENTAL PARA O AUTO-RESIZE */
        .cronograma-table textarea {
            resize: none; /* Impede que o usuário redimensione, pois o JS fará isso */
            overflow: hidden; /* Garante que a barra de rolagem não apareça */
            line-height: 1.2;
            min-height: 38px; /* Altura mínima para uma boa visualização */
        }
        
        .cronograma-table input[type="number"] {
            width: 90%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
        }
        .cronograma-table input[type="checkbox"] {
            cursor: pointer;
        }

        /* Cores de Destaque do Progresso */
        td[style*="#ccffcc"] { /* > 70% */
            background-color: #ccffcc !important;
        }
        td[style*="#ffebcc"] { /* 50% - 70% */
            background-color: #ffebcc !important;
        }
        td[style*="#ffcccc"] { /* < 50% */
            background-color: #ffcccc !important;
        }
    </style>
</head>
<body onload="loadInitialData()">

    <div class="container">
        <h1>Cronograma de Estudos Interativo</h1>
        <p>Preencha os dados de Questões Feitas e Acertadas diretamente na tabela. O progresso é salvo automaticamente no seu navegador.</p>
        
        <div class="summary-box">
            <div class="summary-item">Total de Tarefas: <strong><span id="totalTasksCount">0</span></strong></div>
            <div class="summary-item">Metas Concluídas: <strong><span id="metasConcluidas">0</span></strong></div>
            <div class="summary-item">Progresso Geral (Metas): <strong><span id="progressoGeral">0.0%</span></strong></div>
            <div class="summary-item">Acertos Gerais (Questões): <strong><span id="acertosGerais">0.0%</span></strong></div>
        </div>

        <div class="controls">
            <h3>Controles do Cronograma</h3>
            
            <div class="control-group">
                <h4>Importação e Backup de Dados</h4>
                <div class="input-line">
                    <input type="file" id="fileInput" class="hidden-file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel, .html, .htm" onchange="handleFileUpload()">
                    
                    <button class="action-btn" onclick="document.getElementById('fileInput').click()">Importar Planilha (Excel/CSV/HTML)</button>
                    
                    <p class="file-note">* Para importar ZIP/RAR, descompacte o arquivo primeiro.</p>
                </div>
                <div class="input-line">
                    <button class="action-btn" onclick="exportBackup()">Exportar Backup (JSON)</button>
                    <button class="action-btn" onclick="importBackup()">Importar Backup (JSON)</button>
                </div>
            </div>

            <div class="control-group">
                <h4>Gerenciamento de Abas (Semanas)</h4>
                <div class="input-line">
                    <button class="action-btn" onclick="addSection()">+ Adicionar Nova Aba/Semana</button>
                </div>
                <div class="input-line">
                    <input type="text" id="renameInput" class="rename-input" placeholder="Novo nome da aba/semana">
                    <button class="action-btn" onclick="renameSection()">Renomear Aba Atual</button>
                    <button class="delete-btn" onclick="deleteSection()">Excluir Aba Atual</button>
                </div>
            </div>

            </div>

        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px;">
            <div id="tabNav" class="tab-nav">
                <button class="tab-button" data-semana="progresso" onclick="showTab('progresso')">Progresso por Disciplina</button>
                </div>
        </div>
        <div id="cronogramaSections" class="tab-content-container">
            
            <div id="semana-content-progresso" class="semana-section">
                <h2>Progresso de Questões por Disciplina (Geral)</h2>
                <p>Este relatório consolida os dados de "Questões Feitas" e "Questões Acertadas" de todas as suas semanas.</p>
                <div id="disciplineSummaryTable">
                    </div>
            </div>

            <p style="text-align: center;">Importe seu arquivo Excel ou CSV para exibir seu cronograma.</p>
        </div>

    </div>

    <script>
        let cronogramaData = []; 
        const CRONOGRAMA_SECTIONS = document.getElementById('cronogramaSections');
        const TAB_NAV = document.getElementById('tabNav');
        const RENAME_INPUT = document.getElementById('renameInput'); 
        const CACHE_KEY = 'cronogramaTJCEPersonalData';
        
        let activeSemanaId = null; 
        
        // FUNÇÃO CENTRAL PARA O AUTO-RESIZE DA COLUNA CONTEÚDO
        function autoResizeTextarea(element) {
            if (element.tagName !== 'TEXTAREA') return;
            // Redefine a altura para auto para permitir que encolha
            element.style.height = 'auto'; 
            // Define a altura para o scrollHeight (altura do conteúdo)
            element.style.height = (element.scrollHeight) + 'px';
        }
        
        // NOVO: Função para ajustar textareas em um elemento específico
        function resizeTextareasInElement(element) {
            // Necessário pequeno delay para garantir que o elemento está visível (display: block)
            // e o browser recalculou o scrollHeight
            setTimeout(() => {
                if (element) {
                    element.querySelectorAll('.cronograma-table textarea').forEach(autoResizeTextarea);
                }
            }, 50);
        }

        // === FUNÇÕES DE PERSISTÊNCIA E RENDERIZAÇÃO ===

        function loadInitialData() {
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                try {
                    cronogramaData = JSON.parse(cachedData);
                } catch (e) {
                    console.error("Erro ao carregar dados do cache:", e);
                    localStorage.removeItem(CACHE_KEY);
                    cronogramaData = [];
                }
            }
            
            renderAllSections();
            updateSummary();
        }

        function saveData() {
            localStorage.setItem(CACHE_KEY, JSON.stringify(cronogramaData));
            updateSummary();
        }

        /**
         * Alterna a visualização para a aba (semana) selecionada e salva o ID ativo.
         */
        function showTab(semanaId) {
            // Remove 'active' de todas as abas de conteúdo e botões
            document.querySelectorAll('.semana-section').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            // Adiciona 'active' à aba de conteúdo e botão corretos
            const contentId = `semana-content-${semanaId.replace(/[^a-zA-Z0-9-]/g, '')}`;
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.add('active');
                
                const button = document.querySelector(`.tab-button[data-semana="${semanaId}"]`);
                if (button) {
                    button.classList.add('active');
                }
                
                // *** FIX DE VISIBILIDADE DO CONTEÚDO EM TODAS AS ABAS ***
                resizeTextareasInElement(content);
                
                // Só salva o ID ativo se não for a aba estática de progresso
                if (semanaId !== 'progresso') {
                    activeSemanaId = semanaId; 
                } else {
                    activeSemanaId = null; // A aba de progresso não tem um "ID de semana" gerenciável
                }
            }
        }


        function renderAllSections() {
            // Limpa apenas os botões de abas dinâmicas, mantendo o de 'progresso'
            const progressoButtonHTML = TAB_NAV.querySelector('.tab-button[data-semana="progresso"]').outerHTML;
            TAB_NAV.innerHTML = progressoButtonHTML;
            
            // Limpa as seções dinâmicas e mantém a de progresso
            const progressoContent = document.getElementById('semana-content-progresso');
            CRONOGRAMA_SECTIONS.innerHTML = progressoContent ? progressoContent.outerHTML : ''; 

            
            if (cronogramaData.length === 0) {
                if (!document.getElementById('semana-content-progresso')) {
                    CRONOGRAMA_SECTIONS.innerHTML = '<p style="text-align: center;">Importe seu arquivo Excel ou CSV para exibir seu cronograma.</p>';
                }
                activeSemanaId = null; 
                showTab('progresso');
                return;
            }

            cronogramaData.forEach((section, index) => {
                
                // Cria Botão de Aba
                const tabButton = document.createElement('button');
                tabButton.className = 'tab-button';
                tabButton.textContent = section.semana;
                tabButton.setAttribute('data-semana', section.semana); 
                tabButton.onclick = () => showTab(section.semana);
                TAB_NAV.appendChild(tabButton);


                // Cria Seção de Conteúdo da Semana
                const contentDiv = document.createElement('div');
                contentDiv.className = 'semana-section';
                const normalizedSemanaId = section.semana.replace(/[^a-zA-Z0-9-]/g, '')
                contentDiv.id = `semana-content-${normalizedSemanaId}`;
                
                const title = document.createElement('h2');
                title.textContent = `Semana: ${section.semana}`;
                contentDiv.appendChild(title);

                // --- Botão de inclusão NO TOPO ---
                const addBtnTop = document.createElement('button');
                addBtnTop.className = 'add-btn';
                addBtnTop.textContent = `+ Adicionar Tarefa à ${section.semana}`;
                addBtnTop.onclick = () => addMetaToSection(section.semana);
                contentDiv.appendChild(addBtnTop);

                // Adiciona aviso de renumeração
                if (index === 0) {
                    const renumberingWarning = document.createElement('p');
                    renumberingWarning.style.fontSize = '0.85em';
                    renumberingWarning.style.color = '#cc0000';
                    renumberingWarning.style.marginTop = '10px';
                    renumberingWarning.textContent = 'Atenção: Para manter a sequência de Metas (1, 2, 3...) ao adicionar no meio, edite o número da Meta manualmente na linha.';
                    contentDiv.appendChild(renumberingWarning);
                }
                // --- FIM TOPO ---


                const table = document.createElement('table');
                table.className = 'cronograma-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th class="col-meta">Meta</th>
                            <th class="col-disciplina">Disciplina</th>
                            <th class="col-conteudo">Conteúdo</th>
                            
                            <th class="col-link">TecCon.</th>
                            <th class="col-link">QConc.</th>
                            
                            <th class="col-concluida">Cumpriu?</th>
                            <th class="col-feitas">Feitas</th>
                            <th class="col-acertadas">Acertadas</th>
                            <th class="col-percent">% Acertos</th>
                            <th class="col-acoes">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                `;
                
                const tableBody = table.querySelector('tbody');
                
                
                contentDiv.appendChild(table);

                section.metas.forEach((item, metaIndex) => {
                    renderMetaRow(tableBody, section.semana, item, metaIndex);
                });
                
                // --- Botão de inclusão NO FINAL ---
                const addBtnBottom = document.createElement('button');
                addBtnBottom.className = 'add-btn';
                addBtnBottom.textContent = `+ Adicionar Tarefa à ${section.semana} (Final)`;
                addBtnBottom.onclick = () => addMetaToSection(section.semana);
                addBtnBottom.style.marginTop = '15px'; // Adiciona um espaçamento
                addBtnBottom.style.marginBottom = '20px'; 
                contentDiv.appendChild(addBtnBottom);
                // --- FIM FINAL ---
                
                CRONOGRAMA_SECTIONS.appendChild(contentDiv);
            });
            
            // Exibe a aba correta
            if (activeSemanaId && cronogramaData.some(s => s.semana === activeSemanaId)) {
                showTab(activeSemanaId);
            } else if (cronogramaData.length > 0) {
                showTab(cronogramaData[0].semana);
            } else {
                 showTab('progresso');
            }
        }

        /**
         * Cria uma célula de tabela com um link (se for uma URL válida) ou texto.
         */
        function createLinkCell(url, text, className) {
            const cell = document.createElement('td');
            cell.className = className;
            if (url && (url.startsWith('http') || url.startsWith('www'))) {
                const a = document.createElement('a');
                a.href = url.startsWith('http') ? url : `http://${url}`;
                a.textContent = text;
                a.target = '_blank';
                a.title = url;
                cell.appendChild(a);
            } else if (url) {
                cell.textContent = url; // Display text if it's not a standard link (maybe notes)
                cell.style.fontSize = '0.8em'; // Reduz fonte para texto não-link
            } else {
                cell.textContent = '-';
                cell.style.color = '#999';
            }
            return cell;
        }

        /**
         * Renderiza uma única linha (meta/tarefa) na tabela.
         */
        function renderMetaRow(tableBody, semanaId, item, metaIndex) {
            const row = tableBody.insertRow();
            const normalizedSemanaId = semanaId.replace(/[^a-zA-Z0-9-]/g, '');
            row.id = `row-${normalizedSemanaId}-${metaIndex}`;

            // 1. Campo Meta
            const cellMeta = row.insertCell();
            cellMeta.className = 'col-meta';
            const inputMeta = document.createElement('input');
            inputMeta.type = 'text';
            inputMeta.value = item.meta || '';
            inputMeta.onblur = (e) => updateMetaValue(semanaId, metaIndex, 'meta', e.target.value);
            cellMeta.appendChild(inputMeta);

            // 2. Campo Disciplina
            const cellDisciplina = row.insertCell();
            cellDisciplina.className = 'col-disciplina';
            const inputDisciplina = document.createElement('input');
            inputDisciplina.type = 'text';
            inputDisciplina.value = item.disciplina || '';
            inputDisciplina.onblur = (e) => updateMetaValue(semanaId, metaIndex, 'disciplina', e.target.value);
            cellDisciplina.appendChild(inputDisciplina);

            // 3. Campo Conteúdo (TEXTAREA com auto-resize)
            const cellConteudo = row.insertCell();
            cellConteudo.className = 'col-conteudo';
            const inputConteudo = document.createElement('textarea');
            inputConteudo.value = item.conteudo || '';
            inputConteudo.onblur = (e) => updateMetaValue(semanaId, metaIndex, 'conteudo', e.target.value);
            // VINCULANDO A FUNÇÃO DE AJUSTE AUTOMÁTICO
            inputConteudo.oninput = (e) => autoResizeTextarea(e.target); 
            
            cellConteudo.appendChild(inputConteudo);
            
            // REMOVIDO: Campo Dicas e Orientações

            // 4. Link Tecconcursos 
            row.appendChild(createLinkCell(item.linkTecconcursos, '[Tec]', 'col-link'));

            // 5. Link Qconcursos 
            row.appendChild(createLinkCell(item.linkQconcursos, '[QC]', 'col-link'));

            // REMOVIDO: Link do Material

            // 6. Cumpriu a meta? (Checkbox)
            const cellConcluida = row.insertCell();
            cellConcluida.className = 'col-concluida';
            const check = document.createElement('input');
            check.type = 'checkbox';
            check.checked = item.concluida;
            check.onchange = () => updateMetaValue(semanaId, metaIndex, 'concluida', check.checked);
            cellConcluida.appendChild(check);

            // 7. Questões Feitas (Input Number)
            const cellFeitas = row.insertCell();
            cellFeitas.className = 'col-feitas';
            const inputFeitas = document.createElement('input');
            inputFeitas.type = 'number';
            inputFeitas.min = 0;
            inputFeitas.value = item.feitas || 0;
            inputFeitas.onblur = (e) => updateQuestaoValue(semanaId, metaIndex, 'feitas', parseInt(e.target.value) || 0);
            cellFeitas.appendChild(inputFeitas);

            // 8. Questões Acertadas (Input Number)
            const cellAcertadas = row.insertCell();
            cellAcertadas.className = 'col-acertadas';
            const inputAcertadas = document.createElement('input');
            inputAcertadas.type = 'number';
            inputAcertadas.min = 0;
            inputAcertadas.value = item.acertadas || 0;
            inputAcertadas.onblur = (e) => updateQuestaoValue(semanaId, metaIndex, 'acertadas', parseInt(e.target.value) || 0);
            cellAcertadas.appendChild(inputAcertadas);

            // 9. % de Acertos (Cálculo)
            const cellPercent = row.insertCell();
            cellPercent.className = 'col-percent';
            cellPercent.id = `percent-${normalizedSemanaId}-${metaIndex}`;
            cellPercent.textContent = calculatePercentage(item.feitas, item.acertadas);

            // 10. Ações (Botão Excluir)
            const cellActions = row.insertCell();
            cellActions.className = 'col-acoes';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'Excluir';
            deleteBtn.onclick = () => deleteMeta(semanaId, metaIndex);
            cellActions.appendChild(deleteBtn);
        }
        
        // === FUNÇÕES CRUD (CREATE, READ, UPDATE, DELETE) ===

        /**
         * Adiciona uma nova meta/tarefa à seção da semana com sugestão de Meta.
         */
        function addMetaToSection(semanaId) {
            const sectionIndex = cronogramaData.findIndex(s => s.semana === semanaId);
            if (sectionIndex === -1) return;

            // Lógica de Sugestão Inteligente de Meta
            let maxS = 0;
            cronogramaData[sectionIndex].metas.forEach(m => {
                 const match = String(m.meta).trim().match(/^(\d+)/); 
                 if (match) {
                    maxS = Math.max(maxS, parseInt(match[1]));
                }
            });
            const newMetaNumber = String(maxS + 1);

            const newMeta = { 
                meta: newMetaNumber,
                disciplina: 'Nova Disciplina',
                conteudo: 'Novo Conteúdo/Tarefa (use ENTER para quebra de linha)',
                linkTecconcursos: '', 
                linkQconcursos: '', 
                concluida: false,
                feitas: 0,
                acertadas: 0
            };

            cronogramaData[sectionIndex].metas.push(newMeta);
            saveData();
            renderAllSections(); 
            
            const newIndex = cronogramaData[sectionIndex].metas.length - 1;
            
            // Foca no input da nova linha adicionada
            setTimeout(() => {
                const normalizedSemanaId = semanaId.replace(/[^a-zA-Z0-9-]/g, '');
                const newRow = document.getElementById(`row-${normalizedSemanaId}-${newIndex}`);
                if (newRow) {
                    // Foca no textarea de Conteúdo
                    const textarea = newRow.querySelector('textarea');
                    textarea.focus(); 
                    // Garante que o resize rode no item novo
                    autoResizeTextarea(textarea);
                }
                showTab(semanaId);
            }, 50);
        }

        /**
         * Exclui uma meta/tarefa específica.
         */
        function deleteMeta(semanaId, metaIndex) {
            const metaDesc = cronogramaData.find(s => s.semana === semanaId)?.metas[metaIndex]?.meta || 'selecionada';
            if (!confirm(`Tem certeza que deseja excluir a tarefa da Meta ${metaDesc} da ${semanaId}?`)) {
                return;
            }

            const sectionIndex = cronogramaData.findIndex(s => s.semana === semanaId);
            if (sectionIndex === -1) return;

            cronogramaData[sectionIndex].metas.splice(metaIndex, 1);
            saveData();
            renderAllSections(); 
        }

        /**
         * Atualiza um valor de texto/booleano na meta/tarefa.
         */
        function updateMetaValue(semanaId, metaIndex, key, value) {
            const sectionIndex = cronogramaData.findIndex(s => s.semana === semanaId);
            if (sectionIndex === -1) return;

            // Campos para input direto
            if (key === 'meta' || key === 'disciplina') {
                cronogramaData[sectionIndex].metas[metaIndex][key] = String(value).trim();
            } else {
                // Conteúdo (quebra de linha é permitida), Concluída
                cronogramaData[sectionIndex].metas[metaIndex][key] = value;
            }
            
            saveData();
        }

        /**
         * Atualiza valores de questões e recalcula porcentagem.
         */
        function updateQuestaoValue(semanaId, metaIndex, key, value) {
            const sectionIndex = cronogramaData.findIndex(s => s.semana === semanaId);
            if (sectionIndex === -1) return;

            const item = cronogramaData[sectionIndex].metas[metaIndex];
            value = Math.max(0, parseInt(value) || 0);
            item[key] = value;

            // Regra de validação: acertadas <= feitas
            if (item.acertadas > item.feitas) {
                // Se o campo feito for atualizado para um valor menor que acertadas, acertadas é corrigido
                if (key === 'feitas') {
                    item.acertadas = Math.min(value, item.acertadas);
                    // Atualiza o valor no DOM para refletir a correção
                    document.querySelector(`#row-${semanaId.replace(/[^a-zA-Z0-9-]/g, '')}-${metaIndex} input[type="number"]:last-of-type`).value = item.acertadas;
                } 
                // Se o campo acertadas for atualizado para um valor maior que feitas, feitas é corrigido
                else if (key === 'acertadas') {
                    item.feitas = value;
                    document.querySelector(`#row-${semanaId.replace(/[^a-zA-Z0-9-]/g, '')}-${metaIndex} input[type="number"]:first-of-type`).value = value;
                }
            }

            const percent = calculatePercentage(item.feitas, item.acertadas);
            const normalizedSemanaId = semanaId.replace(/[^a-zA-Z0-9-]/g, '');
            document.getElementById(`percent-${normalizedSemanaId}-${metaIndex}`).textContent = percent;
            
            saveData();
        }

        // === FUNÇÕES DE GERENCIAMENTO DE ABAS (CRIAÇÃO, RENOVAÇÃO E EXCLUSÃO) ===

        /**
         * Adiciona uma nova seção/aba ao cronograma.
         */
        function addSection() {
            // Encontra o próximo número de Semana (ex: S16)
            let maxS = 0;
            cronogramaData.forEach(s => {
                const match = s.semana.match(/S(\d+)/i);
                if (match) {
                    maxS = Math.max(maxS, parseInt(match[1]));
                }
            });
            const newSemanaId = `Semana S${maxS + 1}`;

            cronogramaData.push({ 
                semana: newSemanaId, 
                metas: [] 
            });

            saveData();
            renderAllSections();
            showTab(newSemanaId); 
        }

        /**
         * Renomeia a seção/aba atualmente ativa.
         */
        function renameSection() {
            if (!activeSemanaId) {
                alert("Nenhuma aba selecionada para renomear. Selecione uma aba de Semana.");
                return;
            }

            const newName = RENAME_INPUT.value.trim();
            if (!newName) {
                alert("Por favor, insira um nome válido para a aba.");
                return;
            }

            // Verifica se o novo nome já existe (ignorando a aba atual)
            if (cronogramaData.some(s => s.semana === newName && s.semana !== activeSemanaId)) {
                alert(`A aba "${newName}" já existe. Escolha outro nome.`);
                return;
            }

            const section = cronogramaData.find(s => s.semana === activeSemanaId);
            if (section) {
                section.semana = newName;
                activeSemanaId = newName; 
                saveData();
                renderAllSections();
                RENAME_INPUT.value = '';
                alert(`A aba foi renomeada para "${newName}".`);
            } else {
                alert("Erro: A aba ativa não foi encontrada no cronograma.");
            }
        }

        /**
         * Exclui a seção/aba atualmente ativa.
         */
        function deleteSection() {
            if (!activeSemanaId) {
                alert("Nenhuma aba selecionada para excluir. Selecione uma aba de Semana.");
                return;
            }
            
            // Confirmação para evitar exclusão acidental
            if (!confirm(`Tem certeza que deseja excluir permanentemente a aba "${activeSemanaId}" e todas as suas tarefas?`)) {
                return;
            }

            const sectionIndex = cronogramaData.findIndex(s => s.semana === activeSemanaId);
            
            if (sectionIndex !== -1) {
                const deletedName = cronogramaData[sectionIndex].semana;
                cronogramaData.splice(sectionIndex, 1); 
                activeSemanaId = null; 
                saveData();
                renderAllSections();
                alert(`A aba "${deletedName}" foi excluída com sucesso.`);
            } else {
                alert("Erro: A aba ativa não foi encontrada no cronograma.");
            }
        }


        // === FUNÇÕES DE CÁLCULO E RESUMO ===

        function calculatePercentage(feitas, acertadas) {
            if (!feitas || feitas <= 0) return 'N/A';
            const percent = (acertadas / feitas) * 100;
            return `${percent.toFixed(1)}%`;
        }
        
        /**
         * Agrupa e calcula o percentual de acertos por disciplina.
         */
        function renderDisciplineSummary() {
            const disciplineData = {}; // Estrutura: { 'Disciplina': {feitas: 0, acertadas: 0, taxa: '0%'} }

            cronogramaData.forEach(section => {
                section.metas.forEach(item => {
                    const discName = String(item.disciplina).trim();
                    const feitas = item.feitas || 0;
                    const acertadas = item.acertadas || 0;
                    
                    // Ignora linhas que não têm disciplina e não têm questões
                    if (discName && (feitas > 0 || acertadas > 0)) {
                        if (!disciplineData[discName]) {
                            disciplineData[discName] = { feitas: 0, acertadas: 0 };
                        }
                        disciplineData[discName].feitas += feitas;
                        disciplineData[discName].acertadas += acertadas;
                    }
                });
            });

            const sortedDisciplines = Object.keys(disciplineData).sort();
            let tableHTML = `
                <table class="cronograma-table">
                    <thead>
                        <tr>
                            <th class="col-disciplina" style="width: 300px;">Disciplina</th>
                            <th class="col-feitas" style="width: 150px;">Total de Questões Feitas</th>
                            <th class="col-acertadas" style="width: 150px;">Total de Questões Acertadas</th>
                            <th class="col-percent" style="width: 150px;">% de Acertos (Taxa de Sucesso)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedDisciplines.forEach(discName => {
                const data = disciplineData[discName];
                const percent = calculatePercentage(data.feitas, data.acertadas);

                // Adiciona classe para destaque visual baseado no desempenho 
                let percentClass = '';
                if (percent !== 'N/A') {
                    const rawPercent = parseFloat(percent.replace('%', ''));
                    if (rawPercent < 50) {
                        percentClass = 'style="background-color: #ffcccc;"'; // Vermelho claro
                    } else if (rawPercent < 70) {
                        percentClass = 'style="background-color: #ffebcc;"'; // Laranja claro
                    } else {
                        percentClass = 'style="background-color: #ccffcc;"'; // Verde claro
                    }
                }

                tableHTML += `
                    <tr>
                        <td>${discName}</td>
                        <td>${data.feitas}</td>
                        <td>${data.acertadas}</td>
                        <td class="percent-success" ${percentClass}>${percent}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('disciplineSummaryTable').innerHTML = tableHTML;
        }


        /**
         * Atualiza o resumo, contando a quantidade total de tarefas válidas (linhas não vazias).
         */
        function updateSummary() {
            let metasConcluidas = 0; 
            let totalTasks = 0; 
            let totalFeitas = 0;
            let totalAcertadas = 0;

            cronogramaData.forEach(section => {
                section.metas.forEach(item => {
                    // Contabiliza apenas se tiver pelo menos Meta, Disciplina ou Conteúdo
                    if (item.meta || item.disciplina || item.conteudo) {
                        totalTasks++; 
                        
                        if (item.concluida) {
                            metasConcluidas++;
                        }
                    }

                    totalFeitas += (item.feitas || 0);
                    totalAcertadas += (item.acertadas || 0);
                });
            });
            
            const progressoGeral = totalTasks > 0 ? (metasConcluidas / totalTasks) * 100 : 0;
            const acertosGerais = totalFeitas > 0 ? (totalAcertadas / totalFeitas) * 100 : 0;

            // Atualiza os elementos HTML
            document.getElementById('totalTasksCount').textContent = totalTasks; 
            document.getElementById('metasConcluidas').textContent = metasConcluidas;
            document.getElementById('progressoGeral').textContent = `${progressoGeral.toFixed(1)}%`;
            document.getElementById('acertosGerais').textContent = `${acertosGerais.toFixed(1)}%`;
            
            // Renderiza o resumo de disciplinas
            renderDisciplineSummary();
        }
        
        // === FUNÇÕES DE BACKUP/RESTAURAÇÃO ===
        
        function exportBackup() {
            if (cronogramaData.length === 0) {
                alert("Não há dados para exportar. Por favor, carregue uma planilha ou insira dados primeiro.");
                return;
            }
            
            const data = localStorage.getItem(CACHE_KEY); 
            if (!data) {
                alert("Erro: Não foi possível ler os dados do armazenamento local. Seus dados podem ter sido perdidos.");
                return;
            }

            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').replace('T', '_').split('-')[0];
            a.download = `cronograma_backup_${timestamp}.json`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert("Backup exportado com sucesso! Arquivo: " + a.download);
        }

        function importBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        
                        if (!Array.isArray(importedData) || importedData.length === 0 || !importedData[0].semana || !Array.isArray(importedData[0].metas)) {
                            throw new Error("Estrutura do arquivo JSON inválida. Certifique-se de que é um arquivo de backup gerado por este programa.");
                        }

                        cronogramaData = importedData;
                        localStorage.setItem(CACHE_KEY, JSON.stringify(cronogramaData));
                        renderAllSections();
                        updateSummary();
                        alert(`Backup restaurado com sucesso! ${importedData.length} seções/semanas carregadas.`);

                    } catch (error) {
                        console.error("Erro ao importar backup:", error);
                        alert(`Erro ao carregar o arquivo de backup. Mensagem: ${error.message}`);
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }
        
        // === Função para normalizar cabeçalhos (Torna a importação mais robusta) ===
        function normalizeHeader(text) {
            if (!text) return '';
            // Converte para minúsculas, remove acentos, e remove excesso de espaço
            text = String(text).normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            return text.replace(/\s+/g, ' ').trim();
        }
        // ==============================================================================

        // === FUNÇÕES DE IMPORTAÇÃO UNIVERSAL (EXCEL, CSV e HTML) ===
        
        function handleFileUpload() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const fileName = file.name;
            const extension = fileName.split('.').pop().toLowerCase();

            if (extension === 'csv') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result, fileName);
                };
                // Tenta ler com UTF-8
                reader.readAsText(file, 'UTF-8'); 
            } else if (extension === 'xlsx' || extension === 'xls') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    processWorkbook(workbook, fileName);
                };
                reader.readAsArrayBuffer(file);
            } else if (extension === 'html' || extension === 'htm') {
                 const reader = new FileReader();
                reader.onload = function(e) {
                    processHTML(e.target.result, fileName);
                };
                reader.readAsText(file);
            } else {
                alert(`Extensão de arquivo não suportada: .${extension}. Por favor, use .csv, .xlsx, .xls ou .html.`);
            }
        }

        function processHTML(htmlText, fileName) { 
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlText, 'text/html');
            
            // Tenta encontrar a primeira tabela
            const table = doc.querySelector('table');
            
            if (!table) {
                alert("Erro: O arquivo HTML não contém uma tag <table> para importar.");
                return;
            }

            const htmlData = [];
            
            // Extrai dados da tabela
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const rowData = [];
                // Prioriza <th> para cabeçalhos e <td> para dados
                const cells = row.querySelectorAll('th, td'); 
                cells.forEach(cell => {
                    // Usa innerText para preservar quebras de linha/formato
                    rowData.push(cell.innerText.trim()); 
                });
                if (rowData.length > 0) {
                    htmlData.push(rowData);
                }
            });

            if (htmlData.length > 1) {
                const metas = mapRawDataToCronograma(htmlData, 'Tabela Importada do HTML');
                
                if (metas.length > 0) {
                    cronogramaData = [{ semana: 'Tabela Importada do HTML', metas: metas }]; 
                    localStorage.removeItem(CACHE_KEY); 
                    saveData(); 
                    renderAllSections();
                    showTab('Tabela Importada do HTML'); 
                    alert(`Arquivo HTML "${fileName}" carregado com sucesso! ${metas.length} tarefas encontradas.`);
                } else {
                    alert("Erro: O HTML não contém tarefas válidas (verifique se as colunas 'Meta', 'Disciplina' e 'Conteúdo' estão na primeira linha).");
                }
            } else {
                alert("Erro: A tabela HTML está vazia ou não tem cabeçalho.");
            }
        }

        function processWorkbook(workbook, fileName) {
            const importedData = [];

            workbook.SheetNames.forEach(sheetName => {
                const worksheet = workbook.Sheets[sheetName];
                
                // Mudei para não usar 'header: 1' no sheet_to_json, e sim 'raw: false' para preservar formatação de datas
                const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });
                
                if (excelData.length > 1) { 
                    const metas = mapRawDataToCronograma(excelData, sheetName);
                    if (metas.length > 0) {
                        const cleanSheetName = sheetName.trim(); 
                        importedData.push({ semana: cleanSheetName, metas: metas });
                    }
                }
            });
            
            if (importedData.length > 0) {
                cronogramaData = importedData;
                localStorage.removeItem(CACHE_KEY); 
                saveData(); 
                renderAllSections();
                alert(`Planilha "${fileName}" carregada com sucesso! ${importedData.length} seções/semanas encontradas.`);
            } else {
                alert("Erro: O arquivo não contém abas com dados válidos no formato esperado. Verifique se as colunas 'Meta', 'Disciplina' e 'Conteúdo' estão presentes na primeira linha.");
            }
        }

        // === FUNÇÃO DE MAPA DE DADOS - ALTERADA PARA EXCLUIR COLUNAS ===
        function mapRawDataToCronograma(data, sheetName) {
            const headerRow = data[0];
            const colIndex = {};
            
            headerRow.forEach((h, i) => { 
                // Usa a função de normalização
                const normalized = normalizeHeader(String(h || '')); 
                
                // Colunas obrigatórias
                if (normalized === 'meta') colIndex.meta = i;
                if (normalized === 'disciplina') colIndex.disciplina = i;
                if (normalized === 'conteudo') colIndex.conteudo = i;
                
                // Colunas de Status
                if (normalized.includes('cumpriu a meta')) colIndex.concluida = i;
                if (normalized.includes('questoes feitas')) colIndex.feitas = i;
                if (normalized.includes('questoes acertadas')) colIndex.acertadas = i;

                // Colunas Opcionais de Link (Dicas e Material removidas)
                if (normalized.includes('link tecconcursos')) colIndex.linkTecconcursos = i;
                if (normalized.includes('link qconcurso')) colIndex.linkQconcursos = i; 
                
                // NOTA: 'dicas' e 'link material' foram intencionalmente excluídas daqui.
            });
            
            if (colIndex.meta === undefined || colIndex.disciplina === undefined || colIndex.conteudo === undefined) {
                console.warn(`Aba "${sheetName}" ignorada: Colunas 'Meta', 'Disciplina' ou 'Conteúdo' não encontradas.`);
                return [];
            }


            const metas = [];
            let lastKnownMeta = ''; 

            for (let i = 1; i < data.length; i++) {
                const values = data[i];
                
                const metaRaw = String(values[colIndex.meta] || '').trim().replace('Meta ', '');
                let metaValue = metaRaw; 
                
                const disciplinaValue = String(values[colIndex.disciplina] || '').trim();
                const conteudoValue = String(values[colIndex.conteudo] || '').trim();

                if (!metaValue && !disciplinaValue && !conteudoValue) {
                    continue; 
                }
                
                // Lógica de Herança: se a célula Meta está vazia, herda o valor da última meta explícita.
                if (metaValue.length > 0) {
                    lastKnownMeta = metaValue;
                } else if (lastKnownMeta.length > 0) {
                    // Apenas herda se a linha for uma tarefa válida 
                    if (disciplinaValue.length > 0 || conteudoValue.length > 0) {
                        metaValue = lastKnownMeta;
                    }
                }
                
                const concluidaRaw = String(values[colIndex.concluida] || '').toLowerCase();
                let concluida = false;
                if (concluidaRaw === 'true' || concluidaRaw === 'verdadeiro' || concluidaRaw === 'sim' || concluidaRaw === '1' || concluidaRaw === 'x') {
                    concluida = true;
                }

                const feitas = parseInt(values[colIndex.feitas] || 0) || 0;
                const acertadas = parseInt(values[colIndex.acertadas] || 0) || 0;
                
                metas.push({
                    meta: metaValue, 
                    disciplina: disciplinaValue,
                    // Garante quebra de linha com a substituição (útil principalmente para CSV)
                    conteudo: String(values[colIndex.conteudo] || '').replace(/\\n/g, '\n').trim(), 
                    
                    // Apenas os links de TecConcursos e QConcursos são mantidos
                    linkTecconcursos: String(values[colIndex.linkTecconcursos] || '').trim(), 
                    linkQconcursos: String(values[colIndex.linkQconcursos] || '').trim(), 
                    
                    concluida: concluida,
                    feitas: feitas,
                    acertadas: acertadas
                });
            }
            return metas;
        }
        // ==============================================================================

        function parseCSV(csvText, fileName) {
            let separator = ',';
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            
            // Tenta detectar o separador (vírgula ou ponto e vírgula)
            if (lines.length > 0 && lines[0].includes(';')) {
                separator = ';';
            }

            // Função mais robusta para split que considera aspas
            const splitLine = (line) => {
                const parts = [];
                let current = '';
                let inQuote = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuote = !inQuote;
                    } else if (char === separator && !inQuote) {
                        // Limpa as aspas externas e substitui aspas duplas por simples no conteúdo
                        parts.push(current.replace(/^"|"$/g, '').replace(/""/g, '"')); 
                        current = '';
                    } else {
                        current += char;
                    }
                }
                parts.push(current.replace(/^"|"$/g, '').replace(/""/g, '"'));
                return parts;
            };
            
            const csvData = lines.map(splitLine);
            
            if (csvData.length > 1) {
                const metas = mapRawDataToCronograma(csvData, 'CSV Principal');
                if (metas.length > 0) {
                    // Para CSV, agrupa tudo em uma única seção chamada 'CSV Principal'
                    cronogramaData = [{ semana: 'CSV Principal', metas: metas }]; 
                    localStorage.removeItem(CACHE_KEY); 
                    saveData(); 
                    renderAllSections();
                    showTab('CSV Principal'); 
                    alert(`Arquivo CSV "${fileName}" carregado com sucesso! ${metas.length} tarefas encontradas.`);
                } else {
                    alert("Erro: O CSV não contém tarefas válidas para importação.");
                }
            } else {
                alert("Erro: O arquivo CSV está vazio.");
            }
        }

    </script>
</body>
</html>